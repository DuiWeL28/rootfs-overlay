#!/bin/sh

SUPSRC="/usr/src/sup"

BINS="
	/usr/local/bin/heads-init
"

printsettings() {
	cat <<EOF
/* sup's configuration file */

#define HASH 1
#define DAEMON 0

#ifndef FLAGSONLY

#define USER 1000
#define GROUP -1

#define SETUID 0
#define SETGID 0

#define CHROOT ""
#define CHRDIR ""

static struct rule_t rules[] = {
	/* allow user to run these programs when found in path location */
EOF
}

printrest() {
	cat <<EOF

	{ 0 },
};

#endif
EOF
}

getsha() {
	sha256sum "$1" | cut -d' ' -f1
}

cd $SUPSRC

printsettings > config.h

for exe in "$BINS"; do
	which "$exe" >/dev/null 2>&1 || continue
	printf "\t{ USER, GROUP, \"%s\", \"%s\", \"%s\" },\n" \
		"$(basename $exe)" "$exe" "$(getsha $exe)" >> config.h
done

printrest >> config.h

make clean
make musl
make install
